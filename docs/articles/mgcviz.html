<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mgcViz: visual tools for GAMs • mgcViz</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="mgcViz: visual tools for GAMs">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mgcViz</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mgcviz.html">mgcViz: visual tools for GAMs</a>
    </li>
    <li>
      <a href="../articles/qgam_mgcViz.html">Quantile additive models using qgam and mgcViz</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mfasiolo/mgcViz">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>mgcViz: visual tools for GAMs</h1>
                        <h4 class="author">Matteo Fasiolo and Raphael Nedellec</h4>
            
            <h4 class="date">2018-05-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mfasiolo/mgcViz/blob/master/vignettes/mgcviz.rmd"><code>vignettes/mgcviz.rmd</code></a></small>
      <div class="hidden name"><code>mgcviz.rmd</code></div>

    </div>

    
    
<p>The <code>mgcViz</code> R package offers visual tools for Generalized Additive Models (GAMs). The visualizations provided by <code>mgcViz</code> differs from those implemented in <code>mgcv</code>, in that most of the plots are based on <code>ggplot2</code>’s powerful layering system. This has been implemented by wrapping several <code>ggplot2</code> layers and integrating them with computations specific to GAM models. Further, <code>mgcViz</code> uses binning and/or sub-sampling to produce plots that can scale to large datasets (<span class="math inline">\(n \approx 10^7\)</span>), and offers a variety of new methods for visual model checking/selection.</p>
<p>This document introduces the following categories of visualizations:</p>
<ol style="list-style-type: decimal">
<li><p><strong>smooth and parametric effect plots</strong>: layered plots based on <code>ggplot2</code> and interactive 3d visualizations based on the <code>rgl</code> library;</p></li>
<li><p><strong>model checks</strong>: interactive QQ-plots, traditional residuals plots and layered residuals checks along one or two covariates;</p></li>
<li><p><strong>special plots</strong>: differences-between-smooths plots in 1 or 2D and plotting slices of multidimensional smooth effects.</p></li>
</ol>
<div id="layered-smooth-effect-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#layered-smooth-effect-plots" class="anchor"></a>1 Layered smooth effect plots</h2>
<p>Here we describe effect-specific plotting methods and then we move to the <code>plot.gamViz</code> function, which wraps several effect plots together.</p>
<div id="effect-specific-plots" class="section level4">
<h4 class="hasAnchor">
<a href="#effect-specific-plots" class="anchor"></a>1.1 Effect-specific plots</h4>
<p>Let’s start with a simple example with two smooth effects:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(mgcViz)
n  &lt;-<span class="st"> </span><span class="fl">1e3</span>
dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">"x1"</span> =<span class="st"> </span><span class="kw">rnorm</span>(n), <span class="st">"x2"</span> =<span class="st"> </span><span class="kw">rnorm</span>(n), <span class="st">"x3"</span> =<span class="st"> </span><span class="kw">rnorm</span>(n))
dat$y &lt;-<span class="st"> </span><span class="kw">with</span>(dat, <span class="kw">sin</span>(x1) +<span class="st"> </span><span class="fl">0.5</span>*x2^<span class="dv">2</span> +<span class="st"> </span><span class="fl">0.2</span>*x3 +<span class="st"> </span><span class="kw">pmax</span>(x2, <span class="fl">0.2</span>) *<span class="st"> </span><span class="kw">rnorm</span>(n))
b &lt;-<span class="st"> </span><span class="kw">gam</span>(y ~<span class="st"> </span><span class="kw">s</span>(x1) +<span class="st"> </span><span class="kw">s</span>(x2) +<span class="st"> </span>x3, <span class="dt">data =</span> dat, <span class="dt">method =</span> <span class="st">"REML"</span>)</code></pre></div>
<p>Now we convert the fitted object to the <code>gamViz</code> class. Doing this allows us to use the tools offered by <code>mgcViz</code> and to save quite a lot of time when producing multiple plots using the same fitted GAM model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)</code></pre></div>
<p>We extract the first smooth component using the <code>sm</code> function and we plot it. The resulting <code>o</code> object contains, among other things, a <code>ggplot</code> object. This allows us to add several visual layers.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">o &lt;-<span class="st"> </span><span class="kw">plot</span>( <span class="kw"><a href="../reference/sm.html">sm</a></span>(b, <span class="dv">1</span>) )
o +<span class="st"> </span><span class="kw"><a href="../reference/l_fitLine.html">l_fitLine</a></span>(<span class="dt">colour =</span> <span class="st">"red"</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_rug.html">l_rug</a></span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y), <span class="dt">alpha =</span> <span class="fl">0.8</span>) +
<span class="st">    </span><span class="kw"><a href="../reference/l_ciLine.html">l_ciLine</a></span>(<span class="dt">mul =</span> <span class="dv">5</span>, <span class="dt">colour =</span> <span class="st">"blue"</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) +<span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="../reference/l_points.html">l_points</a></span>(<span class="dt">shape =</span> <span class="dv">19</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="fl">0.1</span>) +<span class="st"> </span><span class="kw">theme_classic</span>()</code></pre></div>
<p><img src="mgcviz_files/figure-html/3-1.png" width="700" style="display:block; margin: auto"></p>
<p>We added the fitted smooth effect, rugs on the x and y axes, confidence lines at 5 standard deviations, partial residual points and we changed the plotting theme to <code><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">ggplot2::theme_classic</a></code>. Functions such as <code>l_fitLine</code> or <code>l_rug</code> are effect-specific layers. To see all the layers available for each effect plot we do:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/listLayers.html">listLayers</a></span>(o)</code></pre></div>
<pre><code>## [1] "l_ciLine"  "l_ciPoly"  "l_fitLine" "l_dens"    "l_points"  "l_rug"</code></pre>
<p>Similar methods exist for 2D smooth effect plots, for instance if we fit:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw">gam</span>(y ~<span class="st"> </span><span class="kw">s</span>(x1, x2) +<span class="st"> </span>x3, <span class="dt">data =</span> dat, <span class="dt">method =</span> <span class="st">"REML"</span>)
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)</code></pre></div>
<p>we can do</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw"><a href="../reference/sm.html">sm</a></span>(b, <span class="dv">1</span>)) +<span class="st"> </span><span class="kw"><a href="../reference/l_fitRaster.html">l_fitRaster</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_fitContour.html">l_fitContour</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_points.html">l_points</a></span>()</code></pre></div>
<p><img src="mgcviz_files/figure-html/7-1.png" width="700" style="display:block; margin: auto"></p>
<p>This can be converted to an interactive <code>plotly</code> plot as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Cannot run this when building the pdf for this vignette, but do try it!</span>
<span class="kw">library</span>(plotly)
<span class="kw"><a href="http://www.rdocumentation.org/packages/plotly/topics/ggplotly">ggplotly</a></span>( <span class="kw">plot</span>(<span class="kw"><a href="../reference/sm.html">sm</a></span>(b, <span class="dv">1</span>)) +<span class="st"> </span><span class="kw"><a href="../reference/l_fitRaster.html">l_fitRaster</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_points.html">l_points</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_fitContour.html">l_fitContour</a></span>()  )</code></pre></div>
<p>We can extract the parametric effect <code>x3</code> using the <code>pterm</code> function (which is the parametric equivalent of <code>sm</code>). We can then plot the two effects on a grid using the <code>gridPrint</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/gridPrint.html">gridPrint</a></span>(<span class="kw">plot</span>(<span class="kw"><a href="../reference/sm.html">sm</a></span>(b, <span class="dv">1</span>)) +<span class="st"> </span><span class="kw"><a href="../reference/l_fitRaster.html">l_fitRaster</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_fitContour.html">l_fitContour</a></span>() +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="ot">NULL</span>) +<span class="st"> </span><span class="kw">guides</span>(<span class="dt">fill=</span><span class="ot">FALSE</span>),
          <span class="kw">plot</span>(<span class="kw"><a href="../reference/pterm.html">pterm</a></span>(b, <span class="dv">1</span>)) +<span class="st"> </span><span class="kw"><a href="../reference/l_ciPoly.html">l_ciPoly</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_fitLine.html">l_fitLine</a></span>(), <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/8a-1.png" width="700" style="display:block; margin: auto"></p>
<p>If needed, we can convert a <code>gamViz</code> object back to its original form by doing:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getGam.html">getGam</a></span>(b)
<span class="kw">class</span>(b)</code></pre></div>
<pre><code>## [1] "gam" "glm" "lm"</code></pre>
<p>The only reason to do so might be to save some memory (<code>gamViz</code> objects store some extra objects).</p>
</div>
<div id="the-plot-gamviz-method" class="section level4">
<h4 class="hasAnchor">
<a href="#the-plot-gamviz-method" class="anchor"></a>1.2 The <code>plot.gamViz</code> method</h4>
<p>The <code>plot.gamViz</code> is the <code>mgcViz</code>’s equivalent of <code><a href="http://www.rdocumentation.org/packages/mgcv/topics/plot.gam">mgcv::plot.gam</a></code>. This function wraps together the plotting methods related to each specific smooth or parametric effect, which can save time when doing GAM modelling. Consider this model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">gamSim</span>(<span class="dv">1</span>,<span class="dt">n=</span><span class="fl">1e3</span>,<span class="dt">dist=</span><span class="st">"normal"</span>,<span class="dt">scale=</span><span class="dv">2</span>)
dat$fac &lt;-<span class="st"> </span><span class="kw">as.factor</span>( <span class="kw">sample</span>(letters[<span class="dv">1</span>:<span class="dv">6</span>], <span class="kw">nrow</span>(dat), <span class="dt">replace =</span> <span class="ot">TRUE</span>) )
b &lt;-<span class="st"> </span><span class="kw">gam</span>(y~<span class="kw">s</span>(x0)+<span class="kw">s</span>(x1, x2)+<span class="kw">s</span>(x3)+fac, <span class="dt">data=</span>dat)</code></pre></div>
<p>To plot all the effects we do:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)
<span class="kw">print</span>(<span class="kw">plot</span>(b, <span class="dt">allTerms =</span> T), <span class="dt">pages =</span> <span class="dv">1</span>) <span class="co"># Calls print.plotGam()</span></code></pre></div>
<p><img src="mgcviz_files/figure-html/11-1.png" width="700" style="display:block; margin: auto"></p>
<p>Here <code>plot</code> calls <code>plot.gamViz</code>, and setting <code>allTerms = TRUE</code> makes so that also the parametric terms are plotted. We are calling <code>print</code> (which uses the <code>print.plotGam</code> method) explicitly, because we want to put all plots on one page. Alternatively we could have simply done:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(b)</code></pre></div>
<p>which plots only the smooth effects, diplaying one on each page.</p>
<p>Notice that <code>plot.gamViz</code> returns an object of class <code>plotGam</code>, which is initially empty. The layers in the previous plots (e.g. the rug and the confidence interval lines) have been added by <code>print.plotGam</code>, which adds some default layers to empty <code>plotGam</code> objects. This can be avoided by setting <code>addLay = FALSE</code> in the call to <code>print.plotGam</code>. A <code>plotGam</code> object in considered not empty if we added objects of class <code>gamLayer</code> to it, for instance:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pl &lt;-<span class="st"> </span><span class="kw">plot</span>(b, <span class="dt">allTerms =</span> T) +<span class="st"> </span><span class="kw"><a href="../reference/l_points.html">l_points</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_fitLine.html">l_fitLine</a></span>(<span class="dt">linetype =</span> <span class="dv">3</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_fitContour.html">l_fitContour</a></span>() +<span class="st"> </span>
<span class="st">      </span><span class="kw"><a href="../reference/l_ciLine.html">l_ciLine</a></span>(<span class="dt">colour =</span> <span class="dv">2</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_ciBar.html">l_ciBar</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_fitPoints.html">l_fitPoints</a></span>(<span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">col =</span> <span class="dv">2</span>) +<span class="st"> </span><span class="kw">theme_get</span>() +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="ot">NULL</span>)
pl$empty <span class="co"># FALSE: because we added gamLayers</span></code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(pl, <span class="dt">pages =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/13-1.png" width="700" style="display:block; margin: auto"></p>
<p>Here all the functions starting with <code>l_</code> return <code>gamLayer</code> objects. Notice that some layers are not relevant to all smooths. For instance, <code>l_fitContour</code> is added only to the second smooth. The <code>+.plotGam</code> method automatically adds each layer only to compatible effect plots.</p>
<p>We can plot individuals effects by using the <code>select</code> arguments. For instance:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(b, <span class="dt">select =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/14-1.png" width="700" style="display:block; margin: auto"> where only the default layers are added. Obviously we can have our custom layers instead:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(b, <span class="dt">select =</span> <span class="dv">1</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_dens.html">l_dens</a></span>(<span class="dt">type =</span> <span class="st">"cond"</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_fitLine.html">l_fitLine</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_ciLine.html">l_ciLine</a></span>()</code></pre></div>
<p><img src="mgcviz_files/figure-html/15-1.png" width="700" style="display:block; margin: auto"> where the <code>l_dens</code> layer represents the conditional density of the partial residuals. Parametric effects always come after smooth or random effects, hence to plot the factor effect we do:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(b, <span class="dt">allTerms =</span> <span class="ot">TRUE</span>, <span class="dt">select =</span> <span class="dv">4</span>) +<span class="st"> </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/15a-1.png" width="700" style="display:block; margin: auto"></p>
</div>
<div id="interactive-rgl-smooth-effect-plots" class="section level4">
<h4 class="hasAnchor">
<a href="#interactive-rgl-smooth-effect-plots" class="anchor"></a>1.3 Interactive <code>rgl</code> smooth effect plots</h4>
<p><code>mgcViz</code> provides tools for generating interactive plots of multidimensional smooths via the <code>rgl</code> R package. Here is an example where we are plotting a 2D slice of a 3D smooth effect, with confidence surfaces:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(mgcViz)
n &lt;-<span class="st"> </span><span class="dv">500</span>
x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n); y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n); z &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n)
ob &lt;-<span class="st"> </span>(x-z)^<span class="dv">2</span> +<span class="st"> </span>(y-z)^<span class="dv">2</span> +<span class="st"> </span><span class="kw">rnorm</span>(n)
b &lt;-<span class="st"> </span><span class="kw">gam</span>(ob ~<span class="st"> </span><span class="kw">s</span>(x, y, z))
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)

<span class="co"># This will not appear in the .pdf or .html document, but do try it!</span>
<span class="kw"><a href="../reference/plotRGL.html">plotRGL</a></span>(<span class="kw"><a href="../reference/sm.html">sm</a></span>(b, <span class="dv">1</span>), <span class="dt">fix =</span> <span class="kw">c</span>(<span class="st">"z"</span> =<span class="st"> </span><span class="dv">0</span>), <span class="dt">residuals =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>The <code>fix</code> argument is used to determine where the 3D effect should be sliced along the z-axis. The plot also shows a subset of residuals (colour-coded depending on sign) that fall close (in term of Euclidean distance) to the selected slice. Notice that <code>plotRGL</code> is not layered at the moment, and most options need to be specified in the initial function call. However, the interactive plot can still be manipulated once the <code>rgl</code> window is open. For instance here we change the aspect ratio:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aspect3d</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</code></pre></div>
<p>We then close the window using:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rgl.close</span>()</code></pre></div>
</div>
</div>
<div id="model-checking" class="section level2">
<h2 class="hasAnchor">
<a href="#model-checking" class="anchor"></a>2 Model checking</h2>
<div id="new-version-of-traditional-model-checks" class="section level4">
<h4 class="hasAnchor">
<a href="#new-version-of-traditional-model-checks" class="anchor"></a>2.1 New version of traditional model checks</h4>
<p>Most of the model checks provided by <code>mgcv</code> are contained in <code>qq.gam</code> and <code>gam.check</code>. <code>mgcViz</code> substitutes them with the more advanced <code>qq.gamViz</code> and <code>check.gamViz</code> methods.</p>
<div id="the-qq-gamviz-method" class="section level5">
<h5 class="hasAnchor">
<a href="#the-qq-gamviz-method" class="anchor"></a>2.1.1 The <code>qq.gamViz</code> method</h5>
<p>Consider the following model with binomial responses:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">0</span>)
n.samp &lt;-<span class="st"> </span><span class="dv">400</span>
dat &lt;-<span class="st"> </span><span class="kw">gamSim</span>(<span class="dv">1</span>,<span class="dt">n =</span> n.samp, <span class="dt">dist =</span> <span class="st">"binary"</span>, <span class="dt">scale =</span> .<span class="dv">33</span>)
p &lt;-<span class="st"> </span><span class="kw">binomial</span>()$<span class="kw">linkinv</span>(dat$f) ## binomial p
n &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>), n.samp, <span class="dt">replace =</span> <span class="ot">TRUE</span>) ## binomial n
dat$y &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n, n, p)
dat$n &lt;-<span class="st"> </span>n
lr.fit &lt;-<span class="st"> </span><span class="kw">gam</span>(y/n ~<span class="st"> </span><span class="kw">s</span>(x0) +<span class="st"> </span><span class="kw">s</span>(x1) +<span class="st"> </span><span class="kw">s</span>(x2) +<span class="st"> </span><span class="kw">s</span>(x3), 
              <span class="dt">family =</span> binomial, <span class="dt">data =</span> dat,
              <span class="dt">weights =</span> n, <span class="dt">method =</span> <span class="st">"REML"</span>)
lr.fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(lr.fit)</code></pre></div>
<p>We can get a QQ-plot of the residuals as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/qq.html">qq</a></span>(lr.fit, <span class="dt">method =</span> <span class="st">"simul1"</span>, <span class="dt">a.qqpoi =</span> <span class="kw">list</span>(<span class="st">"shape"</span> =<span class="st"> </span><span class="dv">1</span>), <span class="dt">a.ablin =</span> <span class="kw">list</span>(<span class="st">"linetype"</span> =<span class="st"> </span><span class="dv">2</span>))</code></pre></div>
<p><img src="mgcviz_files/figure-html/20-1.png" width="700" style="display:block; margin: auto"> Here <code>method</code> determines the method used to compute the QQ-plot, while the arguments starting with <code>a.</code> are lists that will be passed directly to the corresponding <code>ggplot2</code> layer (<code>geom_point</code> and <code>geom_abline</code> here). We can remove the confidence intervals and show all simulated (model-based) QQ-curves as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/qq.html">qq</a></span>(lr.fit, <span class="dt">rep =</span> <span class="dv">20</span>, <span class="dt">show.reps =</span> T, <span class="dt">CI =</span> <span class="st">"none"</span>, <span class="dt">a.qqpoi =</span> <span class="kw">list</span>(<span class="st">"shape"</span> =<span class="st"> </span><span class="dv">19</span>), <span class="dt">a.replin =</span> <span class="kw">list</span>(<span class="st">"alpha"</span> =<span class="st"> </span><span class="fl">0.2</span>))</code></pre></div>
<p><img src="mgcviz_files/figure-html/21-1.png" width="700" style="display:block; margin: auto"></p>
<p>Importantly, <code>mgcViz::qq.gam</code> can handle large datasets by discretizing the QQ-plot before plotting. For instance, let’s increase <code>n.samp</code> in the previous example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">0</span>)
n.samp &lt;-<span class="st"> </span><span class="dv">50000</span>
dat &lt;-<span class="st"> </span><span class="kw">gamSim</span>(<span class="dv">1</span>,<span class="dt">n=</span>n.samp,<span class="dt">dist=</span><span class="st">"binary"</span>,<span class="dt">scale=</span>.<span class="dv">33</span>)
p &lt;-<span class="st"> </span><span class="kw">binomial</span>()$<span class="kw">linkinv</span>(dat$f) ## binomial p
n &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>),n.samp,<span class="dt">replace=</span><span class="ot">TRUE</span>) ## binomial n
dat$y &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n,n,p)
dat$n &lt;-<span class="st"> </span>n
lr.fit &lt;-<span class="st"> </span><span class="kw">bam</span>(y/n ~<span class="st"> </span><span class="kw">s</span>(x0) +<span class="st"> </span><span class="kw">s</span>(x1) +<span class="st"> </span><span class="kw">s</span>(x2) +<span class="st"> </span><span class="kw">s</span>(x3)
              , <span class="dt">family =</span> binomial, <span class="dt">data =</span> dat,
              <span class="dt">weights =</span> n, <span class="dt">method =</span> <span class="st">"fREML"</span>, <span class="dt">discrete =</span> <span class="ot">TRUE</span>)
lr.fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(lr.fit)</code></pre></div>
<p>Here the <code>discrete</code> argument determines whether the QQ-plot is discretized or not. Notice that we can compute the QQ-plot, store it in <code>o</code> and then plot it (via <code>print.qqGam</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">o &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qq.html">qq</a></span>(lr.fit, <span class="dt">rep =</span> <span class="dv">10</span>, <span class="dt">method =</span> <span class="st">"simul1"</span>, <span class="dt">CI =</span> <span class="st">"normal"</span>, <span class="dt">show.reps =</span> <span class="ot">TRUE</span>, 
        <span class="dt">a.replin =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="fl">0.1</span>), <span class="dt">discrete =</span> <span class="ot">TRUE</span>)
o </code></pre></div>
<p><img src="mgcviz_files/figure-html/23-1.png" width="700" style="display:block; margin: auto"></p>
<p>The coarseness of the discretization grid is determined by the <code>ngr</code> argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">o &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qq.html">qq</a></span>(lr.fit, <span class="dt">rep =</span> <span class="dv">10</span>, <span class="dt">method =</span> <span class="st">"simul1"</span>, <span class="dt">CI =</span> <span class="st">"normal"</span>, <span class="dt">show.reps =</span> <span class="ot">TRUE</span>,
        <span class="dt">ngr =</span> <span class="fl">1e2</span>, <span class="dt">a.replin =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="fl">0.1</span>), <span class="dt">a.qqpoi =</span> <span class="kw">list</span>(<span class="dt">shape =</span> <span class="dv">19</span>))
o </code></pre></div>
<p><img src="mgcviz_files/figure-html/24-1.png" width="700" style="display:block; margin: auto"></p>
<p>We can zoom into particular areas of the plot using the <code>zoom</code> generic. Also, given that <code>qq.gamViz</code> and <code>zoom.qqGam</code> output objects of class <code>plotSmooth</code>, we can arrange them using the <code>gridPrint</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/gridPrint.html">gridPrint</a></span>(o, <span class="kw"><a href="../reference/zoom.html">zoom</a></span>(o, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="fl">2.5</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="fl">2.5</span>)), <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/24a-1.png" width="700" style="display:block; margin: auto"></p>
<p>The QQ-plot can also be manipulated interactively using the <code>shine</code> generic, which transforms it into a shiny app:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Cannot run this when building the pdf for this vignette, but do try it!</span>
<span class="kw"><a href="../reference/shine.html">shine</a></span>(o)</code></pre></div>
</div>
<div id="the-check-gamviz-method" class="section level5">
<h5 class="hasAnchor">
<a href="#the-check-gamviz-method" class="anchor"></a>2.1.2 The <code>check.gamViz</code> method</h5>
<p>The <code>check.gamViz</code> method is similar to <code><a href="http://www.rdocumentation.org/packages/mgcv/topics/gam.check">mgcv::gam.check</a></code>, with the difference that it produces a sequence of <code>ggplot</code> objects and that it sub-samples the residuals to avoid over-plotting (or stalling entirely) when dealing with large data sets. Here is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">0</span>)
dat &lt;-<span class="st"> </span><span class="kw">gamSim</span>(<span class="dv">1</span>, <span class="dt">n =</span> <span class="dv">200</span>)</code></pre></div>
<pre><code>## Gu &amp; Wahba 4 term additive model</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw">gam</span>(y ~<span class="st"> </span><span class="kw">s</span>(x0) +<span class="st"> </span><span class="kw">s</span>(x1) +<span class="st"> </span><span class="kw">s</span>(x2) +<span class="st"> </span><span class="kw">s</span>(x3), <span class="dt">data =</span> dat)
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)

<span class="kw">check</span>(b,
      <span class="dt">a.qq =</span> <span class="kw">list</span>(<span class="dt">method =</span> <span class="st">"tnorm"</span>, 
                  <span class="dt">a.cipoly =</span> <span class="kw">list</span>(<span class="dt">fill =</span> <span class="st">"light blue"</span>)), 
      <span class="dt">a.respoi =</span> <span class="kw">list</span>(<span class="dt">size =</span> <span class="fl">0.5</span>), 
      <span class="dt">a.hist =</span> <span class="kw">list</span>(<span class="dt">bins =</span> <span class="dv">10</span>))</code></pre></div>
<pre><code>## 
## Method: GCV   Optimizer: magic
## Smoothing parameter selection converged after 8 iterations.
## The RMS GCV score gradient at convergence was 1.072609e-05 .
## The Hessian was positive definite.
## Model rank =  37 / 37 
## 
## Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
## indicate that k is too low, especially if edf is close to k'.
## 
##         k'  edf k-index p-value
## s(x0) 9.00 2.32    1.00    0.45
## s(x1) 9.00 2.31    0.97    0.34
## s(x2) 9.00 7.65    0.96    0.26
## s(x3) 9.00 1.23    1.04    0.69</code></pre>
<p><img src="mgcviz_files/figure-html/25-1.png" width="700" style="display:block; margin: auto"></p>
<p>The <code>a.qq</code> argument is a list that gets passed directly to <code>qq.gamViz</code>. Similarly, <code>a.repoi</code> is passed to <code>ggplot2::geom_points</code> and <code>a.hist</code> to <code>ggplot2::geom_hist</code>.</p>
</div>
</div>
<div id="new-layered-model-checks" class="section level4">
<h4 class="hasAnchor">
<a href="#new-layered-model-checks" class="anchor"></a>2.2 New layered model checks</h4>
<p>The <code>qq.gamViz</code> and <code>check.gamViz</code> functions are not layered, and in fact require using lists of arguments to be passed to the underlying <code>ggplot2</code> layers. Instead the methods described in this section are fully layered, hence easy to extend and customize.</p>
<div id="one-dimensional-checks-using-check1d" class="section level5">
<h5 class="hasAnchor">
<a href="#one-dimensional-checks-using-check1d" class="anchor"></a>2.2.1 One dimensional checks using <code>check1D</code>
</h5>
<p>This function allows to verify how the residuals vary along one covariate. Consider the following model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">4124</span>)
n &lt;-<span class="st"> </span><span class="fl">1e4</span>
x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n); y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n);
z &lt;-<span class="st"> </span><span class="kw">as.factor</span>( <span class="kw">sample</span>(letters[<span class="dv">1</span>:<span class="dv">6</span>], n, <span class="dt">replace =</span> <span class="ot">TRUE</span>) )

ob &lt;-<span class="st"> </span>(x)^<span class="dv">2</span> +<span class="st"> </span>(y)^<span class="dv">2</span> +<span class="st"> </span>(<span class="fl">0.2</span>*<span class="kw">abs</span>(x) +<span class="st"> </span><span class="dv">1</span>)  *<span class="st"> </span><span class="kw">rnorm</span>(n)
b &lt;-<span class="st"> </span><span class="kw">bam</span>(ob ~<span class="st"> </span><span class="kw">s</span>(x,<span class="dt">k=</span><span class="dv">30</span>) +<span class="st"> </span><span class="kw">s</span>(y, <span class="dt">k=</span><span class="dv">30</span>) +<span class="st"> </span>z, <span class="dt">discrete =</span> <span class="ot">TRUE</span>)
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)</code></pre></div>
<p>Here the responses variance varies a lot along <span class="math inline">\(x\)</span>. Assume that we didn’t know this, but that we wanted to find out whether the residuals are heteroscedastic. We can start by doing the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ck1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(b, <span class="st">"x"</span>)
ck2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(b, <span class="st">"z"</span>)
<span class="kw"><a href="../reference/gridPrint.html">gridPrint</a></span>(ck1, ck2, <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/27-1.png" width="700" style="display:block; margin: auto"></p>
<p>This produces two view along <span class="math inline">\(x\)</span> and <span class="math inline">\(z\)</span>, but as you can see the plots are initially empty. We might want to add a layer showing the conditional distribution of the residuals along <span class="math inline">\(x\)</span> and <span class="math inline">\(z\)</span> and another containing a rug:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/gridPrint.html">gridPrint</a></span>(ck1 +<span class="st"> </span><span class="kw"><a href="../reference/l_dens.html">l_dens</a></span>(<span class="dt">type =</span> <span class="st">"cond"</span>, <span class="dt">alpha =</span> <span class="fl">0.8</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_rug.html">l_rug</a></span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>), 
          ck2 +<span class="st"> </span><span class="kw"><a href="../reference/l_points.html">l_points</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_rug.html">l_rug</a></span>(<span class="dt">alpha =</span> <span class="fl">0.2</span>), <span class="dt">layout_matrix =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>), <span class="dv">1</span>, <span class="dv">3</span>))</code></pre></div>
<p><img src="mgcviz_files/figure-html/28-1.png" width="700" style="display:block; margin: auto"></p>
<p>The left plot suggests that the variance of the residuals might be lower in the middle (<span class="math inline">\(x=0\)</span>), but it is not entirely clear. The <code>l_densCheck</code> layer gives a more clear answer in this case:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ck1 +<span class="st"> </span><span class="kw"><a href="../reference/l_densCheck.html">l_densCheck</a></span>()</code></pre></div>
<p><img src="mgcviz_files/figure-html/29-1.png" width="700" style="display:block; margin: auto"> This layers adds an heatmap proportional to <span class="math inline">\(\{p(r|x)^{1/2} - p_m(r|x)^{1/2}\}^{1/3}\)</span>, where <span class="math inline">\(r\)</span> are the residuals, while <span class="math inline">\(p\)</span> and <span class="math inline">\(p_m\)</span> are their empirical and theoretical (model based) densities. In particular, <span class="math inline">\(p\)</span> is estimated using the the fast k.d.e. method of Wand (1994) (implemented by the <code>kernSmooth</code> package) and <span class="math inline">\(p_m\)</span> is a standard normal density here. This plot makes clear that the residuals are over-dispersed when <span class="math inline">\(x\)</span> is far from zero.</p>
<p>The <code>l_gridCheck1D</code> provides another way of finding residuals patterns. For instance:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b, <span class="dt">nsim =</span> <span class="dv">50</span>)
<span class="kw"><a href="../reference/gridPrint.html">gridPrint</a></span>(<span class="kw"><a href="../reference/check1D.html">check1D</a></span>(b, <span class="st">"x"</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_gridCheck1D.html">l_gridCheck1D</a></span>(<span class="dt">gridFun =</span> sd, <span class="dt">show.reps =</span> <span class="ot">TRUE</span>), 
          <span class="kw"><a href="../reference/check1D.html">check1D</a></span>(b, <span class="st">"z"</span>) +<span class="st"> </span><span class="kw"><a href="../reference/l_gridCheck1D.html">l_gridCheck1D</a></span>(<span class="dt">gridFun =</span> sd, <span class="dt">show.reps =</span> <span class="ot">TRUE</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/30-1.png" width="700" style="display:block; margin: auto"></p>
<p>Here we converted <code>b</code> again using <code>getViz</code> with <code>nsim = 50</code>. This is because <code>l_gridCheck1D</code> needs some simulations to compute the confidence intervals. The simulations are done by <code>getViz</code> and then stored inside <code>b</code>. <code>l_gridCheck1D</code> simply bins the residuals according to their <span class="math inline">\(x\)</span> values, and evaluates a user-defined function (<code>sd</code> here) over the observed and simulated residuals.</p>
</div>
<div id="two-dimensional-checks-using-check2d" class="section level5">
<h5 class="hasAnchor">
<a href="#two-dimensional-checks-using-check2d" class="anchor"></a>2.2.2 Two dimensional checks using <code>check2D</code>
</h5>
<p><code>check2D</code> is quite similar to <code>check1D</code>, but looks at the residuals along two covariates. Here is an example where the mean effect follows the Rosenbrock function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">566</span>)
n &lt;-<span class="st"> </span><span class="fl">1e4</span>
X &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">"x1"</span>=<span class="kw">rnorm</span>(n, <span class="fl">0.5</span>, <span class="fl">0.5</span>), <span class="st">"x2"</span>=<span class="kw">rnorm</span>(n, <span class="fl">1.5</span>, <span class="dv">1</span>), 
                <span class="st">"fac"</span>=<span class="kw">as.factor</span>( <span class="kw">sample</span>(letters[<span class="dv">1</span>:<span class="dv">6</span>], n, <span class="dt">replace =</span> <span class="ot">TRUE</span>) ))
X$y &lt;-<span class="st"> </span>(<span class="dv">1</span>-X$x1)^<span class="dv">2</span> +<span class="st"> </span><span class="dv">100</span>*(X$x2 -<span class="st"> </span>X$x1^<span class="dv">2</span>)^<span class="dv">2</span> +<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">2</span>)
b &lt;-<span class="st"> </span><span class="kw">bam</span>(y ~<span class="st"> </span><span class="kw">te</span>(x1, x2, <span class="dt">k =</span> <span class="dv">5</span>), <span class="dt">data =</span> X, <span class="dt">discrete =</span> <span class="ot">TRUE</span>)
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b, <span class="dt">nsim =</span> <span class="dv">50</span>)</code></pre></div>
<p>We start by generating two 2D views:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ck1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/check2D.html">check2D</a></span>(b, <span class="dt">x1 =</span> <span class="st">"x1"</span>, <span class="dt">x2 =</span> <span class="st">"x2"</span>)
ck2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/check2D.html">check2D</a></span>(b, <span class="dt">x1 =</span> <span class="st">"x2"</span>, <span class="dt">x2 =</span> X$fac) +<span class="st"> </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"fac"</span>)</code></pre></div>
<p>Then we add the <code>l_gridCheck2D</code> layer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ck1 +<span class="st"> </span><span class="kw"><a href="../reference/l_gridCheck2D.html">l_gridCheck2D</a></span>(<span class="dt">gridFun =</span> mean)</code></pre></div>
<p><img src="mgcviz_files/figure-html/33-1.png" width="700" style="display:block; margin: auto"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ck2 +<span class="st"> </span><span class="kw"><a href="../reference/l_gridCheck2D.html">l_gridCheck2D</a></span>(<span class="dt">gridFun =</span> mean)</code></pre></div>
<p><img src="mgcviz_files/figure-html/33-2.png" width="700" style="display:block; margin: auto"></p>
<p><code>l_gridCheck2D</code> bins the observed and simulated residuals, summarizes them using a scalar-valued function (<code>mean</code> here), and adds a heatmap of the observed summary in each cell, normalized using the <code>nsim</code> summaries obtained using the simulations. In the first plot above, the pattern in the residual means is not very well visible, due to outliers on the far right. The pattern is made more visible by zooming on the center of the distribution and by changing the size of the bins:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ck1 +<span class="st"> </span><span class="kw"><a href="../reference/l_gridCheck2D.html">l_gridCheck2D</a></span>(<span class="dt">bw =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.1</span>)) +<span class="st"> </span><span class="kw">xlim</span>(-<span class="dv">1</span>, <span class="dv">1</span>) +<span class="st"> </span><span class="kw">ylim</span>(<span class="dv">0</span>, <span class="dv">3</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/34-1.png" width="700" style="display:block; margin: auto"></p>
<p>As for smooth effect plots, we can list the available layers by doing:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/listLayers.html">listLayers</a></span>( ck1 ) </code></pre></div>
<pre><code>## [1] "l_gridCheck2D" "l_dens"        "l_glyphs2D"    "l_points"     
## [5] "l_rug"</code></pre>
<p>The most sophisticated layer is probably <code>l_glyphs2D</code> which we illustrate here using an heteroscedastic model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">4124</span>)
n &lt;-<span class="st"> </span><span class="fl">1e4</span>
dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">"x1"</span> =<span class="st"> </span><span class="kw">rnorm</span>(n), <span class="st">"x2"</span> =<span class="st"> </span><span class="kw">rnorm</span>(n))
dat$y &lt;-<span class="st"> </span>(dat$x1)^<span class="dv">2</span> +<span class="st"> </span>(dat$x2)^<span class="dv">2</span> +<span class="st"> </span>(<span class="dv">1</span>*<span class="kw">abs</span>(dat$x1) +<span class="st"> </span><span class="dv">1</span>)  *<span class="st"> </span><span class="kw">rnorm</span>(n)
b &lt;-<span class="st"> </span><span class="kw">bam</span>(y ~<span class="st"> </span><span class="kw">s</span>(x1,<span class="dt">k=</span><span class="dv">30</span>) +<span class="st"> </span><span class="kw">s</span>(x2, <span class="dt">k=</span><span class="dv">30</span>), <span class="dt">data =</span> dat, <span class="dt">discrete =</span> <span class="ot">TRUE</span>)
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)

ck &lt;-<span class="st"> </span><span class="kw"><a href="../reference/check2D.html">check2D</a></span>(b, <span class="dt">x1 =</span> <span class="st">"x1"</span>, <span class="dt">x2 =</span> <span class="st">"x2"</span>, <span class="dt">type =</span> <span class="st">"tnormal"</span>)</code></pre></div>
<p>Similarly to <code>l_gridCheck2D</code>, <code>l_glyphs2D</code> bins the residuals according to two covariates, but the user-defined function used to summarize the residuals in each bin has to return a <code>data.frame</code>, rather than a scalar. Here is an example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">glyFun &lt;-<span class="st"> </span>function(.d){
  .r &lt;-<span class="st"> </span>.d$z
  .qq &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>( <span class="kw">density</span>(.r)[<span class="kw">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="dt">n =</span> <span class="dv">100</span> )
  .qq$colour &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">ifelse</span>(<span class="kw">length</span>(.r)&gt;<span class="dv">50</span>, <span class="st">"black"</span>, <span class="st">"red"</span>), <span class="kw">nrow</span>(.qq))
  <span class="kw">return</span>( .qq )
}

ck +<span class="st"> </span><span class="kw"><a href="../reference/l_glyphs2D.html">l_glyphs2D</a></span>(<span class="dt">glyFun =</span> glyFun, <span class="dt">ggLay =</span> <span class="st">"geom_path"</span>, <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">8</span>, <span class="dv">8</span>),
                <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x=</span>gx, <span class="dt">y=</span>gy, <span class="dt">group =</span> gid, <span class="dt">colour =</span> <span class="kw">I</span>(colour)), 
                <span class="dt">height=</span><span class="fl">1.5</span>, <span class="dt">width =</span> <span class="dv">1</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/37-1.png" width="700" style="display:block; margin: auto"></p>
<p>Each glyph represend a kernel density of the residuals, with colours indicating whether we have more (black) or less (red) that 50 observations in that bin. It is clear that the residuals are much less variable for <span class="math inline">\(x \approx 0\)</span> than elsewhere. We can do the same using binned worm-plots:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">glyFun &lt;-<span class="st"> </span>function(.d){
  n &lt;-<span class="st"> </span><span class="kw">nrow</span>(.d)
  px &lt;-<span class="st"> </span><span class="kw">qnorm</span>( (<span class="dv">1</span>:n -<span class="st"> </span><span class="fl">0.5</span>)/(n) )
  py &lt;-<span class="st"> </span><span class="kw">sort</span>( .d$z )
  clr &lt;-<span class="st"> </span>if(n &gt;<span class="st"> </span><span class="dv">50</span>) { <span class="st">"black"</span> } else { <span class="st">"red"</span> }
  clr &lt;-<span class="st"> </span><span class="kw">rep</span>(clr, n)
  <span class="kw">return</span>( <span class="kw">data.frame</span>(<span class="st">"x"</span> =<span class="st"> </span>px, <span class="st">"y"</span> =<span class="st"> </span>py -<span class="st"> </span>px, <span class="st">"colour"</span> =<span class="st"> </span>clr))
}

ck +<span class="st"> </span><span class="kw"><a href="../reference/l_glyphs2D.html">l_glyphs2D</a></span>(<span class="dt">glyFun =</span> glyFun, <span class="dt">ggLay =</span> <span class="st">"geom_point"</span>, <span class="dt">n =</span> <span class="kw">c</span>(<span class="dv">10</span>, <span class="dv">10</span>),
                <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x=</span>gx, <span class="dt">y=</span>gy, <span class="dt">group =</span> gid, <span class="dt">colour =</span> <span class="kw">I</span>(colour)),
                <span class="dt">height=</span><span class="dv">2</span>, <span class="dt">width =</span> <span class="dv">1</span>, <span class="dt">size =</span> <span class="fl">0.2</span>) </code></pre></div>
<p><img src="mgcviz_files/figure-html/38-1.png" width="700" style="display:block; margin: auto"></p>
<p>Notice that worm-plots (Buuren and Fredriks, 2001) are simply rotated QQ-plots. An horizontal plot indicates well specified residual model. An increasing (decreasing) worm indicates over (under) dispersion.</p>
</div>
</div>
</div>
<div id="special-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#special-plots" class="anchor"></a>3 Special plots</h2>
<div id="differences-between-smooths-plots" class="section level4">
<h4 class="hasAnchor">
<a href="#differences-between-smooths-plots" class="anchor"></a>3.1 Differences-between-smooths plots</h4>
<p>Plotting the difference between two smooth effects can be useful when working with by-factor smooths. For example, here we are fitting a model containing a smooth along <code>x2</code> for each value of the <code>fac</code> factor variable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">6898</span>)
dat &lt;-<span class="st"> </span><span class="kw">gamSim</span>(<span class="dv">1</span>,<span class="dt">n=</span><span class="dv">1500</span>,<span class="dt">dist=</span><span class="st">"normal"</span>,<span class="dt">scale=</span><span class="dv">20</span>)
dat$fac &lt;-<span class="st"> </span><span class="kw">as.factor</span>( <span class="kw">sample</span>(<span class="kw">c</span>(<span class="st">"A1"</span>, <span class="st">"A2"</span>, <span class="st">"A3"</span>), <span class="kw">nrow</span>(dat), <span class="dt">replace =</span> <span class="ot">TRUE</span>) ) 
bs &lt;-<span class="st"> "cr"</span>; k &lt;-<span class="st"> </span><span class="dv">12</span>
b &lt;-<span class="st"> </span><span class="kw">gam</span>(y ~<span class="st"> </span><span class="kw">s</span>(x2,<span class="dt">bs=</span>bs,<span class="dt">by =</span> fac), <span class="dt">data=</span>dat)
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)</code></pre></div>
<p>We can plot the difference between the smooths corresponding to levels <code>"A1"</code> and <code>"A2"</code>, by extracting the two smooths and then feeding them to the <code>plotDiff</code> generic:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plotDiff.html">plotDiff</a></span>(<span class="dt">s1 =</span> <span class="kw"><a href="../reference/sm.html">sm</a></span>(b, <span class="dv">1</span>), <span class="dt">s2 =</span> <span class="kw"><a href="../reference/sm.html">sm</a></span>(b, <span class="dv">2</span>)) +<span class="st"> </span><span class="kw"><a href="../reference/l_ciPoly.html">l_ciPoly</a></span>() +<span class="st"> </span>
<span class="st">         </span><span class="kw"><a href="../reference/l_fitLine.html">l_fitLine</a></span>() +<span class="st"> </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">linetype =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="mgcviz_files/figure-html/39a-1.png" width="700" style="display:block; margin: auto"></p>
<p>Notice that the credible intervals for the difference smooth produced by <code>plotDiff</code> take into account the cross-covariance between the two smooths.</p>
</div>
<div id="plotting-multiple-slices-of-multi-dimensional-smooth-effects" class="section level4">
<h4 class="hasAnchor">
<a href="#plotting-multiple-slices-of-multi-dimensional-smooth-effects" class="anchor"></a>3.2 Plotting multiple slices of multi-dimensional smooth effects</h4>
<p>When dealing with smooth effects defined on more than two dimensions, it is often useful to visualize them as a sequence of 2D slices. The <code>plotSlice</code> function provides such functionality, by exploiting the faceting tools offerered by <code>ggplot2</code>. For instance, here we are slicing a 4D smooth effect along two variables:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="fl">5e3</span>
x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n); y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n); z &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n); z2 &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n)
ob &lt;-<span class="st"> </span>(x-z)^<span class="dv">2</span> +<span class="st"> </span>(y-z)^<span class="dv">2</span> +<span class="st"> </span>z2^<span class="dv">3</span> +<span class="st"> </span><span class="kw">rnorm</span>(n)
b &lt;-<span class="st"> </span><span class="kw">bam</span>(ob ~<span class="st"> </span><span class="kw">s</span>(x, y, z, z2), <span class="dt">discrete =</span> <span class="ot">TRUE</span>)
v &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getViz.html">getViz</a></span>(b)

<span class="co"># Plot slices across "z" and "x"</span>
pl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plotSlice.html">plotSlice</a></span>(<span class="dt">x =</span> <span class="kw"><a href="../reference/sm.html">sm</a></span>(v, <span class="dv">1</span>), 
                <span class="dt">fix =</span> <span class="kw">list</span>(<span class="st">"z"</span> =<span class="st"> </span><span class="kw">seq</span>(-<span class="dv">2</span>, <span class="dv">2</span>, <span class="dt">length.out =</span> <span class="dv">3</span>), <span class="st">"x"</span> =<span class="st"> </span><span class="kw">c</span>(-<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)))
pl +<span class="st"> </span><span class="kw"><a href="../reference/l_fitRaster.html">l_fitRaster</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_fitContour.html">l_fitContour</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_points.html">l_points</a></span>() +<span class="st"> </span><span class="kw"><a href="../reference/l_rug.html">l_rug</a></span>()</code></pre></div>
<p><img src="mgcviz_files/figure-html/40-1.png" width="700" style="display:block; margin: auto"></p>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<ul>
<li><p>Buuren, S. v. and Fredriks, M. (2001) Worm plot: a simple diagnostic device for modelling growth reference curves, Statistics in medicine, 20, 1259–1277.</p></li>
<li><p>Murdoch, D. (2001) Rgl: An r interface to opengl, in Proceedings of DSC, p. 2.</p></li>
<li><p>Wand, M. P. (1994) Fast computation of multivariate kernel estimators, Journal of Computational and Graphical Statistics, 3, 433–445</p></li>
<li><p>Wickham, H. (2009) ggplot2: Elegant Graphics for Data Analysis, Springer-Verlag New York.</p></li>
<li><p>Wickham, H. (2010) A layered grammar of graphics, Journal of Computational and Graphical Statistics, 19, 3–28.</p></li>
<li><p>Wood, S.N. (2017) Generalized Additive Models: An Introduction with R (2nd edition). Chapman and Hall/CRC.</p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#layered-smooth-effect-plots">1 Layered smooth effect plots</a></li>
      <li><a href="#model-checking">2 Model checking</a></li>
      <li><a href="#special-plots">3 Special plots</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matteo Fasiolo, Raphael Nedellec.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
